## YachtPricer — структура MVP (обновлённая)

### Основные модули

1. **Аналитика по флоту, загрузке, ценам и динамике**

   * Поддержка ролей:

     * **Администратор системы** — глобальные права, управление пользователями, компаниями, флотами.
     * **Менеджер флота** — работает в рамках своей компании, видит только свои лодки.
     * **Владелец лодки** — доступ только к своей лодке, может подтверждать скидку.
   * Multi-tenancy: поддержка множества чартерных компаний в одном инстансе (Company → Fleet → Yacht).

2. **Статистика цен по годам и периодам**

   * Таблица `price_snapshot` (недельные снимки цен).
   * Агрегация по неделям (min/avg/median/max/p25/p75).
   * YoY сравнение по тем же неделям разных лет.
   * Материализованные представления для ускорения.
   * UI: линейный график + таблица + YoY-серии.

3. **Рекомендации по скидке (TOP3/TOP1)**

   * MVP: алгоритм сортировки конкурентов.

     * Чтобы попасть в TOP1 → цена = цена лидера – Δ.
     * Чтобы попасть в TOP3 → цена = цена третьего места – Δ.
   * Δ = шаг (например, 50 €).
   * Долгосрочно: ML-модель прогнозирования вероятности бронирования в зависимости от цены.
   * Для ML заранее накапливаем факт броней.

4. **Учёт Last Minute**

   * Флаг `is_last_minute` в `price_snapshot`.
   * Определение: check-in < 30 дней и/или скидка типа «Last minute» (из NauSYS API).
   * Две витрины:

     * Основная (без LM).
     * Вторая — только LM.
   * Рекомендации: если <30 дней до заезда → учитываем только LM-конкурентов.
   * Добавить fallback-эвристику: days\_to\_checkin < 30 и скидка ≥ 10–15%.

5. **Модуль сбора цен с внешних источников**

   * Приоритет: официальные API и партнёрства.
   * Разрешённый скрапинг (Playwright) только для источников с согласия, с respect robots.txt, rate limiting, фича-флагами.
   * CSV/Excel импорт как универсальный канал (ручной/полуавто).
   * CompetitorPrice обновляется из этих каналов.
   * Юр. политика: никакого «дикого» скрапинга.

---

### План работ (MVP)

1. Реализовать систему ролей и multi-tenancy.
2. Сделать хранение и агрегацию `price_snapshot` с недельной статистикой.
3. Построить экран аналитики цен (график + таблица + YoY).
4. Добавить алгоритм рекомендаций TOP3/TOP1.
5. Учёт last minute цен (флаг, витрины, рекомендации).
6. Подключение внешних данных: API → разрешённый скрапинг → CSV импорт.
