# YachtPricer – YachtEditPage-concept

1. Как работает неделя на странице редактирования
	•	В Dashboard и Pricing уже есть week в query-строке (?week=2025-11-29).
	•	При переходе в «Редактировать яхту» мы сохраняем тот же search в Link:

<Link to={{ pathname: `/yacht/${y.id}/edit`, search }} />


	•	На YachtEditPage (а точнее в YachtEditForm) мы:
	•	читаем week из location.search,
	•	вычисляем weekStartDate (Date),
	•	прокидываем её дальше до секции цен.

Таким образом, страница редактирования точно знает, с какой неделей сейчас работает пользователь, и показывает / разрешает редактирование цен в том же «контексте недели», что и Dashboard / Pricing.

2. Секции и что в них редактируем

Оставляем текущую структуру:
	1.	Ответственный менеджер – редактируем.
	2.	Общие сведения – редактируем.
	3.	Характеристики – редактируем.
	4.	Доп. сервисы – редактируем.
	5.	Цены и скидки – почти вся секция read-only, кроме Last Minute:

В секции «Цены и скидки»:
	•	Базовая цена (на выбранную неделю) – read-only
берём из WeekSlot.basePrice для этой недели, либо, если нет, fallback на Yacht.basePrice.
	•	Текущая скидка – read-only
currentDiscountPct (из нашего YachtDetailsDto-подобного DTO).
	•	Максимальная скидка % – read-only
исторически хранится в яхте maxDiscountPct.
	•	Данные обновлены: – read-only
берём currentPriceUpdatedAt ?? fetchedAt.
	•	Last minute base price – единственное поле, которое можно менять в этой секции.

3. Правило включения Last Minute Base Price

Last Minute поле:
	•	видно всегда, чтобы менеджер понимал, что оно существует.
	•	редактируемо только если выполняются два условия:
	1.	У пользователя есть роль FLEET_MANAGER (или более высокая, если решим).
	2.	selectedWeekStart - today < 21 дней (строго меньше трёх недель до начала недели).

Технически:
	•	Берём week из URL → weekDate (начало недели/суббота).
	•	Берём today = new Date() (локальное время сервера или клиента — обсудим при реализации).
	•	Считаем разницу в днях:

const diffMs = weekDate.getTime() - today.getTime();
const diffDays = diffMs / (1000 * 60 * 60 * 24);
const canEditLastMinute = diffDays < 21;


	•	В UI для Last Minute:
	•	disabled={!canEditLastMinute || !isFleetManager}
	•	если disabled, можно показывать подсказку:
«Last minute price можно редактировать только за 3 недели до начала чартерной недели».

4. Где хранится Last Minute цена

Сейчас она технически «ездит» в basePrice формы. Концептуально:
	•	Базовая цена по неделе → это WeekSlot.basePrice.
	•	Last minute base price – отдельное поле (скорее всего, тоже привязанное к WeekSlot, либо к отдельной таблице, но на уровне UI мы считаем, что оно относится к текущей выбранной неделе).

При реализации мы либо:
	•	добавим в бэкенд WeekSlot.lastMinuteBasePrice,
либо
	•	будем временно использовать существующие поля (например, отдельную PriceHistory запись с особой пометкой), но концепт уже «под недельный слот».

Главное: страница редактирования не правит саму базовую недельную цену (её мы согласовываем через Pricing-процесс), а только Last Minute override для ближайших недель.

⸻

Если кратко:
Редактор яхты теперь больше про «карточку лодки» и менеджера, а не про массовое управление ценами. Управление базовыми недельными ценами — через Pricing; в YachtEdit только один emergency-инструмент для Last Minute, и он жёстко ограничен по времени и роли. Концепт мне нравится, он хорошо ложится на нашу архитектуру с WeekSlot.