# ---------- base ----------
    FROM node:20-alpine AS base
    WORKDIR /app
    RUN apk add --no-cache libc6-compat openssl
    
    # ---------- deps (–≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞—è dev) ----------
    FROM base AS deps
    COPY package*.json ./
    RUN npm ci
    
    # ---------- build ----------
    FROM deps AS build
    # –ö–ª–∞–¥—ë–º prisma —Ä—è–¥–æ–º —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (–Ω–µ –≤ src/)
    COPY prisma ./prisma
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç (–±–µ—Ä—ë—Ç schema –∏–∑ /app/prisma/schema.prisma)
    RUN npx prisma generate
    
    # –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –∏ —Å–æ–±–∏—Ä–∞–µ–º
    COPY tsconfig*.json ./
    COPY src ./src
    RUN npm run build
    
    # ---------- runner ----------
    FROM base AS runner
    ENV NODE_ENV=production
    WORKDIR /app
    
    # –ö–æ–ø–∏—Ä—É–µ–º node_modules (–æ—Å—Ç–∞–≤–ª—è–µ–º dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —á—Ç–æ–±—ã –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω npx prisma)
    COPY --from=deps /app/node_modules ./node_modules
    
    # –ö–æ–ø–∏—Ä—É–µ–º –±–∏–ª–¥ –∏ prisma (–Ω—É–∂–Ω–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –≤ —Ä–∞–Ω—Ç–∞–π–º–µ)
    COPY --from=build /app/dist ./dist
    COPY --from=build /app/prisma ./prisma
    COPY package*.json ./
    
    # üëá –¥–æ–±–∞–≤–∏–ª–∏ entrypoint.sh
    COPY entrypoint.sh ./entrypoint.sh
    RUN chmod +x ./entrypoint.sh
    
    EXPOSE 8000
    
    # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –Ω–∞—à entrypoint (–≤–Ω—É—Ç—Ä–∏ –æ–Ω –¥–µ–ª–∞–µ—Ç migrate deploy –∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç app)
    ENTRYPOINT ["sh", "./entrypoint.sh"]
    
    # ---------- devtools (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è prisma studio) ----------
    FROM build AS devtools
    CMD ["npx", "prisma", "studio", "--port", "5555"]