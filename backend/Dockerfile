# ---------- base ----------
    FROM node:20-alpine AS base
    WORKDIR /app
    RUN apk add --no-cache libc6-compat openssl
    
    # ---------- deps (–≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞—è dev) ----------
    FROM base AS deps
    WORKDIR /app
    # –í–ê–ñ–ù–û: –∫–æ–ø–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏, —á—Ç–æ–±—ã –∫—ç—à –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª—Å—è
    COPY package.json ./
    COPY package-lock.json ./

    # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∑–∞—è–≤–ª–µ–Ω–∞ –≤ package.json
    RUN node -e "const p=require('./package.json'); if(!p.dependencies || !p.dependencies['@clerk/backend']){console.error('NO @clerk/backend in package.json'); process.exit(1)}"

    # –°—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ lock-—Ñ–∞–π–ª—É
    RUN npm ci

    # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–∞–∫–µ—Ç —Ä–µ–∞–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    RUN node -e "require.resolve('@clerk/backend/package.json'); console.log('clerk/backend OK')"
    
    # ---------- build ----------
    FROM deps AS build
    # –ö–ª–∞–¥—ë–º prisma —Ä—è–¥–æ–º —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º (–Ω–µ –≤ src/)
    COPY prisma ./prisma
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç (–±–µ—Ä—ë—Ç schema –∏–∑ /app/prisma/schema.prisma)
    RUN npx prisma generate --schema=prisma/schema.prisma
    
    # –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –∏ —Å–æ–±–∏—Ä–∞–µ–º
    COPY tsconfig*.json ./
    COPY src ./src
    RUN npm run build
    
    # ---------- runner ----------
    FROM base AS runner
    ENV NODE_ENV=production
    WORKDIR /app
    
    # –ö–æ–ø–∏—Ä—É–µ–º node_modules (–æ—Å—Ç–∞–≤–ª—è–µ–º dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —á—Ç–æ–±—ã –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω npx prisma)
    COPY --from=deps /app/node_modules ./node_modules
    
    # –ö–æ–ø–∏—Ä—É–µ–º –±–∏–ª–¥ –∏ prisma (–Ω—É–∂–Ω–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –≤ —Ä–∞–Ω—Ç–∞–π–º–µ)
    COPY --from=build /app/dist ./dist
    COPY --from=build /app/prisma ./prisma
    COPY package*.json ./
    
    # üëá –¥–æ–±–∞–≤–∏–ª–∏ entrypoint.sh
    COPY entrypoint.sh ./entrypoint.sh
    RUN chmod +x ./entrypoint.sh
    
    EXPOSE 8000
    
    # –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –Ω–∞—à entrypoint (–≤–Ω—É—Ç—Ä–∏ –æ–Ω –¥–µ–ª–∞–µ—Ç migrate deploy –∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç app)
    ENTRYPOINT ["sh", "./entrypoint.sh"]
    
    # ---------- devtools (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è prisma studio) ----------
    FROM build AS devtools
    CMD ["npx", "prisma", "studio", "--port", "5555"]