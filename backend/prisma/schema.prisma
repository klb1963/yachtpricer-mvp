generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ENUMS
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum WeekSlotStatus {
  BOOKED
  OPEN
  OPTION
}

enum YachtType {
  monohull
  catamaran
  trimaran
  compromis
}

enum ScrapeSource {
  BOATAROUND
  SEARADAR
  NAUSYS
}

enum JobStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum DecisionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

// --- RBAC: Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ---
enum Role {
  ADMIN
  FLEET_MANAGER
  MANAGER
  OWNER
}

// --- Ğ ĞµĞ¶Ğ¸Ğ¼Ñ‹ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ ÑÑ…Ñ‚Ñ‹ ---
enum OwnerMode {
  ACTIVE
  VIEW_ONLY
  HIDDEN
}

// --- ĞÑƒĞ´Ğ¸Ñ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¿Ğ¾ workflow PricingDecision ---
enum AuditAction {
  SUBMIT
  APPROVE
  REJECT
}

enum FilterScope {
  ORG // Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ²ÑĞµĞ¹ Ğ¾Ñ€Ğ³.
  USER // Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
}

enum LocationSource {
  NAUSYS
  INTERNAL
}

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// MODELS
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique

  // ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹
  contactName  String?
  contactPhone String?
  contactEmail String?
  websiteUrl   String?

  yachts       Yacht[]
  subscription Subscription?

  users       User[]
  ownerYachts OwnerYacht[] @relation("OrgOwnerYachts")

  // ğŸ‘‡ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ° ÑĞ²ÑĞ·Ğ¸ Ğº CompetitorFilters
  competitorFilters CompetitorFilters[]

  createdAt DateTime @default(now())
}

model Subscription {
  id    String       @id @default(cuid())
  orgId String       @unique
  org   Organization @relation(fields: [orgId], references: [id])

  plan             String    @default("PRO") // Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ° enum Ğ¿Ğ¾Ğ·Ğ¶Ğµ
  status           String    @default("active")
  currentPeriodEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Yacht {
  id       String  @id @default(uuid())
  nausysId String? @unique // ğŸ‘ˆ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ID NauSYS

  name                 String
  manufacturer         String
  model                String
  type                 YachtType @default(monohull)
  length               Float
  builtYear            Int
  cabins               Int
  heads                Int
  basePrice            Decimal   @db.Decimal(12, 2)
  location             String
  fleet                String
  charterCompany       String
  currentExtraServices Json

  imageUrl String?

  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  managerLinks ManagerYacht[]

  ownerLinks OwnerYacht[] @relation("OwnerYachtToYacht")

  ownerId   String?
  ownerName String?
  owner     Owner?  @relation(fields: [ownerId], references: [id])

  weekSlots           WeekSlot[]
  extraServiceHistory ExtraServiceHistory[]
  competitorPrices    CompetitorPrice[]
  competitorSnapshots CompetitorSnapshot[]
  pricingDecisions    PricingDecision[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([manufacturer, model])
  @@index([location])
  @@map("yachts")
}

model Owner {
  id     String  @id @default(uuid())
  name   String
  email  String  @unique
  phone  String?
  yachts Yacht[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("owners")
}

model WeekSlot {
  id      String @id @default(uuid())
  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  startDate       DateTime
  status          WeekSlotStatus
  currentPrice    Decimal        @db.Decimal(12, 2)
  currentDiscount Decimal        @db.Decimal(12, 2)

  priceHistory PriceHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([yachtId, startDate])
  @@index([yachtId, startDate])
  @@map("week_slots")
}

model PriceHistory {
  id         String   @id @default(uuid())
  weekSlot   WeekSlot @relation(fields: [weekSlotId], references: [id])
  weekSlotId String

  date     DateTime @default(now())
  price    Decimal  @db.Decimal(12, 2)
  discount Decimal  @db.Decimal(12, 2)
  authorId String?
  note     String?

  createdAt DateTime @default(now())

  @@map("price_history")
}

model ExtraServiceHistory {
  id      String @id @default(uuid())
  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  date        DateTime @default(now())
  serviceName String
  price       Decimal  @db.Decimal(12, 2)
  note        String?
  authorId    String?

  createdAt DateTime @default(now())

  @@map("extra_service_history")
}

model CompetitorPrice {
  id      String  @id @default(uuid())
  yacht   Yacht?  @relation(fields: [yachtId], references: [id])
  yachtId String?

  // Ğ½ĞµĞ´ĞµĞ»Ñ Ñ‡Ğ°Ñ€Ñ‚ĞµÑ€Ğ½Ğ°Ñ (ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°)
  weekStart DateTime
  source    ScrapeSource

  // ĞºÑ‚Ğ¾ Ğ¸ Ñ‡Ñ‚Ğ¾: Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
  competitorYacht String
  price           Decimal  @db.Decimal(12, 2)
  currency        String
  link            String
  scrapedAt       DateTime @default(now())
  raw             Json?

  // ğŸ‘‡ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ Boataround
  scrapeJob   ScrapeJob? @relation(fields: [scrapeJobId], references: [id])
  scrapeJobId String?

  externalId  String? // ID Ğ»Ğ¾Ğ´ĞºĞ¸ Ñƒ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ñ‰Ğ¸ĞºĞ° (ĞµÑĞ»Ğ¸ ÑĞ¼Ğ¾Ğ¶ĞµĞ¼ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚ÑŒ)
  year        Int?
  cabins      Int?
  heads       Int?
  lengthFt    Float? // ÑƒĞ´Ğ¾Ğ±Ğ½ĞµĞµ ÑÑ€Ğ°Ğ·Ñƒ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ñ„ÑƒÑ‚Ğ°Ñ…
  marina      String?
  discountPct Decimal? @db.Decimal(12, 2) // Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞºĞ¸Ğ´ĞºĞ° Ğ½Ğ° Ğ¸Ñ‚Ğ¾Ğ³ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² â€œĞ¿Ñ€Ğ°Ğ¹ÑĞ°â€
  feesTotal   Decimal? @db.Decimal(12, 2) // Ğ´Ğ¾Ğ¿. ÑĞ±Ğ¾Ñ€Ñ‹ (Ñ‡Ğ¸ÑÑ‚ĞºĞ°/Ñ‚ÑƒÑ€Ğ¸ÑÑ‚.Ğ½Ğ°Ğ»Ğ¾Ğ³ Ğ¸ Ñ‚.Ğ¿.), ĞµÑĞ»Ğ¸ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼

  // Ñ‡Ğ°ÑÑ‚Ğ¾ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ + Ğ½ĞµĞ´ĞµĞ»Ñ + Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº:
  @@unique([source, link, weekStart])
  @@index([weekStart, source])
  @@index([yachtId, weekStart, source])
  @@map("competitor_prices")
}

model ScrapeJob {
  id         String       @id @default(uuid())
  source     ScrapeSource
  status     JobStatus
  params     Json
  createdAt  DateTime     @default(now())
  startedAt  DateTime?
  finishedAt DateTime?
  error      String?

  // ğŸ‘‡ ÑĞ²ÑĞ·ÑŒ Ğº Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼
  results CompetitorPrice[]

  @@map("scrape_jobs")
}

model CompetitorSnapshot {
  id String @id @default(uuid())

  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  weekStart   DateTime
  source      ScrapeSource
  top1Price   Decimal      @db.Decimal(12, 2)
  top3Avg     Decimal      @db.Decimal(12, 2)
  currency    String
  sampleSize  Int
  rawStats    Json?
  collectedAt DateTime     @default(now())
  createdAt   DateTime     @default(now())

  @@unique([yachtId, weekStart, source])
  @@index([yachtId, weekStart])
  @@map("competitor_snapshots")
}

model PricingDecision {
  id          String         @id @default(uuid())
  yachtId     String
  yacht       Yacht?         @relation(fields: [yachtId], references: [id])
  weekStart   DateTime
  basePrice   Decimal        @db.Decimal(12, 2)
  top1        Decimal?       @db.Decimal(12, 2)
  top3        Decimal?       @db.Decimal(12, 2)
  mlReco      Decimal?       @db.Decimal(12, 2)
  discountPct Decimal?       @db.Decimal(12, 2)
  finalPrice  Decimal?       @db.Decimal(12, 2)
  status      DecisionStatus @default(DRAFT)
  approvedBy  String?
  approvedAt  DateTime?
  notes       String?
  auditJson   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs PriceAuditLog[] @relation("DecisionAuditLogs")

  @@unique([yachtId, weekStart])
  @@index([weekStart]) // ğŸ‘ˆ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ğ¾ Ğ½ĞµĞ´ĞµĞ»Ğµ
  @@index([status]) // ğŸ‘ˆ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ
  @@map("pricing_decisions")
}

// --- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ clerkId/oidc sub) ---
model User {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?
  role  Role

  // ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ (ĞµÑÑ‚ÑŒ DEFAULT_ORG_SLUG=aquatoria)
  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  // ÑĞ²ÑĞ·Ğ¸
  // ğŸ‘‡ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ° ÑĞ²ÑĞ·Ğ¸ CompetitorFilters.user
  competitorFilters CompetitorFilters[]
  managerLinks      ManagerYacht[]
  ownerLinks        OwnerYacht[]
  auditLogs         PriceAuditLog[]     @relation("AuditActor")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// --- ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ğº ÑÑ…Ñ‚Ğµ (ĞºÑ‚Ğ¾ Â«Ğ²ĞµĞ´Ñ‘Ñ‚Â» ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½ÑƒÑ ÑÑ…Ñ‚Ñƒ) ---
model ManagerYacht {
  id        String @id @default(cuid())
  managerId String
  yachtId   String

  manager User  @relation(fields: [managerId], references: [id])
  yacht   Yacht @relation(fields: [yachtId], references: [id])

  @@unique([managerId, yachtId])
  @@index([yachtId])
  @@map("manager_yachts")
}

// --- ĞŸÑ€Ğ¸Ğ²ÑĞ·ĞºĞ° Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° (user Ñ Ñ€Ğ¾Ğ»ÑŒÑ OWNER) Ğº ÑÑ…Ñ‚Ğµ + Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° ---
model OwnerYacht {
  id      String @id @default(cuid())
  ownerId String
  yachtId String

  // Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ°Ñ… org
  orgId String?
  // ğŸ‘‡ Ğ´Ğ°Ñ‘Ğ¼ Ğ¸Ğ¼Ñ ÑĞ²ÑĞ·Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ OwnerYacht â†” Organization
  org   Organization? @relation("OrgOwnerYachts", fields: [orgId], references: [id])

  owner User @relation(fields: [ownerId], references: [id])

  // ğŸ‘‡ Ğ´Ğ°Ñ‘Ğ¼ Ğ¸Ğ¼Ñ ÑĞ²ÑĞ·Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ OwnerYacht â†” Yacht
  yacht Yacht @relation("OwnerYachtToYacht", fields: [yachtId], references: [id])

  mode      OwnerMode @default(VIEW_ONLY)
  allowEdit Boolean   @default(false)

  @@unique([ownerId, yachtId])
  @@index([yachtId])
  @@map("owner_yachts")
}

model PriceAuditLog {
  id String @id @default(cuid())

  decisionId String

  decision PricingDecision @relation("DecisionAuditLogs", fields: [decisionId], references: [id])

  action     AuditAction
  fromStatus DecisionStatus?
  toStatus   DecisionStatus

  actorId String?
  actor   User?   @relation("AuditActor", fields: [actorId], references: [id])

  comment   String?
  createdAt DateTime @default(now())

  @@index([decisionId])
  @@index([actorId])
  @@map("price_audit_logs")
}

model Country {
  id        String   @id @default(cuid())
  nausysId  Int      @unique // ID Ğ¸Ğ· /countries
  code2     String   @unique @db.Char(2) // ISO-3166-1 alpha-2 (FR)
  code3     String?  @db.Char(3) // ISO-3166-1 alpha-3 (FRA)
  name      String // "France"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ğŸ‘‡ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ°Ñ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ° ÑĞ²ÑĞ·Ğ¸ Ğ¿Ğ¾ ISO-2
  locations Location[] @relation("CountryCode2Locations")

  @@index([name])
  @@map("countries")
}

model Location {
  id          String         @id @default(cuid())
  source      LocationSource @default(NAUSYS)
  externalId  String? // Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, locationId Ğ¸Ğ· NauSYS (ĞºĞ°Ğº ÑÑ‚Ñ€Ğ¾ĞºĞ°)
  code        String?
  name        String
  countryCode String?        @db.Char(2) // ISO-2
  lat         Float? // NEW
  lon         Float? // NEW
  parentId    String?
  parent      Location?      @relation("LocationToChildren", fields: [parentId], references: [id])
  children    Location[]     @relation("LocationToChildren")

  competitorFilters CompetitorFilters[] @relation("FiltersLocations")
  aliases           LocationAlias[]     @relation("LocationAliases")

  // ğŸ‘‡ ÑĞ²ÑĞ·ÑŒ Ğ½Ğ° Country Ğ¿Ğ¾ code2 (ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ â€” ÑÑ‚Ğ¾ Ğ¾Ğº)
  country Country? @relation("CountryCode2Locations", fields: [countryCode], references: [code2])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([source, externalId])
  @@index([source])
  @@index([countryCode])
  @@map("locations")
}

model LocationAlias {
  id         String @id @default(cuid())
  alias      String
  normalized String
  locationId String

  // ğŸ‘‡ ÑĞ²ÑĞ·Ğ°Ğ»Ğ¸ Ñ Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑĞ²ÑĞ·ÑŒÑ "LocationAliases"
  location Location @relation("LocationAliases", fields: [locationId], references: [id])

  @@unique([normalized])
  @@index([locationId])
  @@map("location_aliases")
}

model CompetitorFilters {
  id String @id @default(cuid())

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  scope FilterScope @default(ORG)

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  lenFtMinus  Int @default(3)
  lenFtPlus   Int @default(3)
  yearMinus   Int @default(2)
  yearPlus    Int @default(2)
  peopleMinus Int @default(1)
  peoplePlus  Int @default(1)
  cabinsMinus Int @default(1)
  cabinsPlus  Int @default(1)
  headsMin    Int @default(0)

  locations Location[] @relation("FiltersLocations")

  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, scope, userId])
  @@index([scope])
  @@index([orgId])
  @@index([userId])
  @@map("competitor_filters")
}
