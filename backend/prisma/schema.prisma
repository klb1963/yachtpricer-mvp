generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
/// ENUMS
/// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

enum WeekSlotStatus {
  BOOKED
  OPEN
  OPTION
}

enum YachtType {
  monohull
  catamaran
  trimaran
  compromis
}

enum ScrapeSource {
  BOATAROUND
  SEARADAR
  NAUSYS
  INNERDB
}

enum JobStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum DecisionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

// --- RBAC: —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
enum Role {
  ADMIN
  FLEET_MANAGER
  MANAGER
  OWNER
}

// --- –†–µ–∂–∏–º—ã –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —è—Ö—Ç—ã ---
enum OwnerMode {
  ACTIVE
  VIEW_ONLY
  HIDDEN
}

// --- –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–æ workflow PricingDecision ---
enum AuditAction {
  SUBMIT
  APPROVE
  REJECT
}

enum FilterScope {
  ORG // —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ–π –æ—Ä–≥.
  USER // –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
}

enum LocationSource {
  NAUSYS
  INTERNAL
}

enum PriceSource {
  INTERNAL
  NAUSYS
  BOOKING_MANAGER
  OTHER
}

/// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
/// MODELS
/// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique

  // –∫–æ–Ω—Ç–∞–∫—Ç—ã
  contactName  String?
  contactPhone String?
  contactEmail String?
  websiteUrl   String?

  yachts       Yacht[]
  subscription Subscription?

  users       User[]
  ownerYachts OwnerYacht[] @relation("OrgOwnerYachts")

  // üëá –æ–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–≤—è–∑–∏ –∫ CompetitorFilters
  competitorFilters CompetitorFilters[]

  presets CompetitorFilterPreset[]  @relation("OrgPresets")

  createdAt DateTime @default(now())
}

model Subscription {
  id    String       @id @default(cuid())
  orgId String       @unique
  org   Organization @relation(fields: [orgId], references: [id])

  plan             String    @default("PRO") // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ enum –ø–æ–∑–∂–µ
  status           String    @default("active")
  currentPeriodEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Yacht {
  id       String  @id @default(uuid())
  nausysId String? @unique // üëà –≤–Ω–µ—à–Ω–∏–π ID NauSYS

  name                 String
  manufacturer         String
  model                String
  type                 YachtType? 
  length               Float
  builtYear            Int
  cabins               Int
  heads                Int
  basePrice            Decimal   @db.Decimal(12, 2)
  maxDiscountPct       Decimal?  @db.Decimal(5, 2)
  location             String?
  fleet                String
  charterCompany       String
  currentExtraServices Json
  imageUrl String?

  // --- —Å–≤—è–∑–∏ —Å–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏ ---
  countryId  String?
  country    Country?       @relation(fields: [countryId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  categoryId Int?
  category   YachtCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  builderId  Int?
  builder    YachtBuilder?  @relation(fields: [builderId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  managerLinks ManagerYacht[]

  ownerLinks OwnerYacht[] @relation("OwnerYachtToYacht")

  ownerId   String?
  ownerName String?
  owner     Owner?  @relation(fields: [ownerId], references: [id])

  weekSlots           WeekSlot[]
  extraServiceHistory ExtraServiceHistory[]
  competitorPrices    CompetitorPrice[]
  competitorSnapshots CompetitorSnapshot[]
  pricingDecisions    PricingDecision[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([manufacturer, model])
  @@index([location])
  @@map("yachts")
}

model Owner {
  id     String  @id @default(uuid())
  name   String
  email  String  @unique
  phone  String?
  yachts Yacht[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("owners")
}

model WeekSlot {
  id      String @id @default(uuid())
  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  startDate DateTime
  status    WeekSlotStatus

  // –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞/—Å–∫–∏–¥–∫–∞ –Ω–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é (—ç—Ç–æ "Actual price")
  currentPrice    Decimal @db.Decimal(12, 2)
  currentDiscount Decimal @db.Decimal(5, 2)

  // –ù–û–í–û–ï: –æ—Ç–∫—É–¥–∞ –≤–∑—è–ª–∏ —Ü–µ–Ω—É –∏ –∫–æ–≥–¥–∞
  priceSource    PriceSource?
  priceFetchedAt DateTime?

  priceHistory PriceHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([yachtId, startDate])
  @@index([yachtId, startDate])
  @@map("week_slots")
}

model PriceHistory {
  id         String   @id @default(uuid())
  weekSlot   WeekSlot @relation(fields: [weekSlotId], references: [id])
  weekSlotId String

  date     DateTime @default(now())
  price    Decimal  @db.Decimal(12, 2)
  discount Decimal  @db.Decimal(12, 2)

  // –ù–û–í–û–ï: –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø–∏—Å–∏
  source PriceSource?

  authorId String?
  note     String?

  createdAt DateTime @default(now())

  @@map("price_history")
}

model ExtraServiceHistory {
  id      String @id @default(uuid())
  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  date        DateTime @default(now())
  serviceName String
  price       Decimal  @db.Decimal(12, 2)
  note        String?
  authorId    String?

  createdAt DateTime @default(now())

  @@map("extra_service_history")
}

model CompetitorPrice {
  id      String  @id @default(uuid())
  yacht   Yacht?  @relation(fields: [yachtId], references: [id])
  yachtId String?

  // –Ω–µ–¥–µ–ª—è —á–∞—Ä—Ç–µ—Ä–Ω–∞—è (—Å—É–±–±–æ—Ç–∞)
  weekStart DateTime
  source    ScrapeSource

  // –∫—Ç–æ –∏ —á—Ç–æ: –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
  competitorYacht String
  price           Decimal  @db.Decimal(12, 2)
  currency        String
  link            String
  scrapedAt       DateTime @default(now())
  raw             Json?

  // üëá –Ω–æ–≤—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –ø–æ–ª—è –¥–ª—è Boataround
  scrapeJob   ScrapeJob? @relation(fields: [scrapeJobId], references: [id])
  scrapeJobId String?

  externalId  String? // ID –ª–æ–¥–∫–∏ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–µ—Å–ª–∏ —Å–º–æ–∂–µ–º –¥–æ—Å—Ç–∞—Ç—å)
  year        Int?
  cabins      Int?
  heads       Int?
  lengthFt    Float? // —É–¥–æ–±–Ω–µ–µ —Å—Ä–∞–∑—É —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ—É—Ç–∞—Ö
  marina      String?
  discountPct Decimal? @db.Decimal(12, 2) // —Ä–µ–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –Ω–∞ –∏—Ç–æ–≥ –ø—Ä–æ—Ç–∏–≤ ‚Äú–ø—Ä–∞–π—Å–∞‚Äù
  feesTotal   Decimal? @db.Decimal(12, 2) // –¥–æ–ø. —Å–±–æ—Ä—ã (—á–∏—Å—Ç–∫–∞/—Ç—É—Ä–∏—Å—Ç.–Ω–∞–ª–æ–≥ –∏ —Ç.–ø.), –µ—Å–ª–∏ —Å—á–∏—Ç–∞–µ–º

  // –≥–µ–æ-–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
  countryCode String?  // ISO-2 ("HR", "GR", ...)
  countryId   String?  // FK -> Country.id (–Ω–∞—à UUID)
  country     Country? @relation(fields: [countryId], references: [id])

  // —á–∞—Å—Ç–æ —É–¥–æ–±–Ω–æ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ + –Ω–µ–¥–µ–ª—è + –∏—Å—Ç–æ—á–Ω–∏–∫:
  @@unique([source, link, weekStart])
  @@index([weekStart, source])
  @@index([yachtId, weekStart, source])
  @@map("competitor_prices")
}

model ScrapeJob {
  id         String       @id @default(uuid())
  source     ScrapeSource
  status     JobStatus
  params     Json
  createdAt  DateTime     @default(now())
  startedAt  DateTime?
  finishedAt DateTime?
  error      String?

  // üëá —Å–≤—è–∑—å –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
  results CompetitorPrice[]

  @@map("scrape_jobs")
}

model CompetitorSnapshot {
  id String @id @default(uuid())

  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  weekStart   DateTime
  source      ScrapeSource
  top1Price   Decimal      @db.Decimal(12, 2)
  top3Avg     Decimal      @db.Decimal(12, 2)
  currency    String
  sampleSize  Int
  rawStats    Json?
  collectedAt DateTime     @default(now())
  createdAt   DateTime     @default(now())

  @@unique([yachtId, weekStart, source])
  @@index([yachtId, weekStart])
  @@map("competitor_snapshots")
}

model PricingDecision {
  id          String         @id @default(uuid())
  yachtId     String
  yacht       Yacht?         @relation(fields: [yachtId], references: [id])
  weekStart   DateTime
  basePrice   Decimal        @db.Decimal(12, 2)
  top1        Decimal?       @db.Decimal(12, 2)
  top3        Decimal?       @db.Decimal(12, 2)
  mlReco      Decimal?       @db.Decimal(12, 2)
  discountPct Decimal?       @db.Decimal(12, 2)
  finalPrice  Decimal?       @db.Decimal(12, 2)
  status      DecisionStatus @default(DRAFT)
  approvedBy  String?
  approvedAt  DateTime?
  notes       String?
  auditJson   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs PriceAuditLog[] @relation("DecisionAuditLogs")

  @@unique([yachtId, weekStart])
  @@index([weekStart]) // üëà –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –ø–æ –Ω–µ–¥–µ–ª–µ
  @@index([status]) // üëà –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –ø–æ —Å—Ç–∞—Ç—É—Å—É
  @@map("pricing_decisions")
}

// --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å clerkId/oidc sub) ---
model User {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?
  role  Role

  // –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å—Ç—å DEFAULT_ORG_SLUG=aquatoria)
  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  // —Å–≤—è–∑–∏
  // üëá –æ–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–≤—è–∑–∏ CompetitorFilters.user
  competitorFilters CompetitorFilters[]
  managerLinks      ManagerYacht[]
  ownerLinks        OwnerYacht[]
  auditLogs         PriceAuditLog[]     @relation("AuditActor")

  presets CompetitorFilterPreset[]  @relation("UserPresets")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// --- –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫ —è—Ö—Ç–µ (–∫—Ç–æ ¬´–≤–µ–¥—ë—Ç¬ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —è—Ö—Ç—É) ---
model ManagerYacht {
  id        String @id @default(cuid())
  managerId String
  yachtId   String

  manager User  @relation(fields: [managerId], references: [id])
  yacht   Yacht @relation(fields: [yachtId], references: [id])

  @@unique([managerId, yachtId])
  @@index([yachtId])
  @@map("manager_yachts")
}

// --- –ü—Ä–∏–≤—è–∑–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (user —Å —Ä–æ–ª—å—é OWNER) –∫ —è—Ö—Ç–µ + —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞ ---
model OwnerYacht {
  id      String @id @default(cuid())
  ownerId String
  yachtId String

  // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å—Ç—Ä–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö org
  orgId String?
  // üëá –¥–∞—ë–º –∏–º—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É OwnerYacht ‚Üî Organization
  org   Organization? @relation("OrgOwnerYachts", fields: [orgId], references: [id])

  owner User @relation(fields: [ownerId], references: [id])

  // üëá –¥–∞—ë–º –∏–º—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É OwnerYacht ‚Üî Yacht
  yacht Yacht @relation("OwnerYachtToYacht", fields: [yachtId], references: [id])

  mode      OwnerMode @default(VIEW_ONLY)
  allowEdit Boolean   @default(false)

  @@unique([ownerId, yachtId])
  @@index([yachtId])
  @@map("owner_yachts")
}

model PriceAuditLog {
  id String @id @default(cuid())

  decisionId String

  decision PricingDecision @relation("DecisionAuditLogs", fields: [decisionId], references: [id])

  action     AuditAction
  fromStatus DecisionStatus?
  toStatus   DecisionStatus

  actorId String?
  actor   User?   @relation("AuditActor", fields: [actorId], references: [id])

  comment   String?
  createdAt DateTime @default(now())

  @@index([decisionId])
  @@index([actorId])
  @@map("price_audit_logs")
}

// –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ countries –∏–∑ NauSYS
model Country {
  id        String   @id @default(cuid())
  nausysId  Int      @unique // ID –∏–∑ /countries
  code2     String   @unique @db.Char(2) // ISO-3166-1 alpha-2 (FR)
  code3     String?  @db.Char(3) // ISO-3166-1 alpha-3 (FRA)
  name      String // "France"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üëá –æ–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ —Å–≤—è–∑–∏ –ø–æ ISO-2
  locations         Location[]          @relation("CountryCode2Locations")

  // —Å—Ç–∞—Ä–∞—è —Å–≤—è–∑—å —Ä–µ–≥–∏–æ–Ω–æ–≤ –ø–æ nausysId (–æ—Å—Ç–∞—ë—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞)
  regionsByNausys   Region[]            @relation("RegionCountryNausys")

  // –Ω–æ–≤–∞—è —Å–≤—è–∑—å —Ä–µ–≥–∏–æ–Ω–æ–≤ –ø–æ UUID —Å—Ç—Ä–∞–Ω—ã
  regions           Region[]

  // –ù–û–í–û–ï: –æ–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –¥–ª—è Location.countryId (UUID FK)
  locationsById     Location[]

  competitorFilters CompetitorFilters[] @relation("FiltersCountries")

  yachts            Yacht[]

  // —Å–≤—è–∑—å —Å CompetitorPrice.countryId
  competitorPrices  CompetitorPrice[]

  @@index([name])
  @@map("countries")
}

// –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ regions –∏–∑ NauSYS
model Region {
  id       Int     @id @default(autoincrement())
  nausysId Int     @unique
  names    Json
  nameEn   String? @map("name_en")
  nameDe   String? @map("name_de")
  nameRu   String? @map("name_ru")

  // --- –°–¢–ê–†–ê–Ø –°–í–Ø–ó–¨ (–æ—Å—Ç–∞–≤–ª—è–µ–º): —á–µ—Ä–µ–∑ nausysId
  countryNausysId Int?
  countryByNausys Country? @relation("RegionCountryNausys", fields: [countryNausysId], references: [nausysId])

  // --- –ù–û–í–ê–Ø –°–í–Ø–ó–¨: FK –Ω–∞ Country.id (UUID)
  // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∫–∞—Å–∫–∞–¥–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤: countryIds[] -> regions
  countryId String?
  country   Country? @relation(fields: [countryId], references: [id])

  // –ù–û–í–û–ï: –æ–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –¥–ª—è Location.regionId
  locations Location[]

  competitorFilters CompetitorFilters[] @relation("FiltersRegions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryId])
  @@index([countryNausysId])
  @@map("regions")
}

// –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ locations –∏–∑ NauSYS
model Location {
  id          String         @id @default(cuid())
  source      LocationSource @default(NAUSYS)
  externalId  String? // –Ω–∞–ø—Ä–∏–º–µ—Ä, locationId –∏–∑ NauSYS (–∫–∞–∫ —Å—Ç—Ä–æ–∫–∞)
  code        String?
  name        String
  countryCode String?        @db.Char(2) // ISO-2
  lat         Float? // NEW
  lon         Float? // NEW
  parentId    String?
  parent      Location?      @relation("LocationToChildren", fields: [parentId], references: [id])
  children    Location[]     @relation("LocationToChildren")

  competitorFilters CompetitorFilters[] @relation("FiltersLocations")
  aliases           LocationAlias[]     @relation("LocationAliases")

  // --- –°–¢–ê–†–ê–Ø –°–í–Ø–ó–¨ (–æ—Å—Ç–∞–≤–ª—è–µ–º): —á–µ—Ä–µ–∑ ISO-2 code2
  countryByCode2 Country? @relation("CountryCode2Locations", fields: [countryCode], references: [code2])

  // --- –ù–û–í–û–ï: —Å—Å—ã–ª–∫–∞ –Ω–∞ Region –ø–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É PK
  // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∫–∞—Å–∫–∞–¥–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤: regionIds[] -> locations
  regionId Int?
  region   Region? @relation(fields: [regionId], references: [id])

  // --- –ù–û–í–û–ï: —Å—Å—ã–ª–∫–∞ –Ω–∞ Country –ø–æ UUID
  // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∫–∞—Å–∫–∞–¥–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–µ
  countryId String?
  country   Country? @relation(fields: [countryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([regionId])
  @@index([countryId])
  @@unique([source, externalId])
  @@index([source])
  @@index([countryCode])
  @@map("locations")
}

model LocationAlias {
  id         String @id @default(cuid())
  alias      String
  normalized String
  locationId String

  // üëá —Å–≤—è–∑–∞–ª–∏ —Å –∏–º–µ–Ω–æ–≤–∞–Ω–Ω–æ–π —Å–≤—è–∑—å—é "LocationAliases"
  location Location @relation("LocationAliases", fields: [locationId], references: [id])

  @@unique([normalized])
  @@index([locationId])
  @@map("location_aliases")
}

model CompetitorFilters {
  id String @id @default(cuid())

  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  scope FilterScope @default(ORG)

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  lenFtMinus  Int @default(3)
  lenFtPlus   Int @default(3)
  yearMinus   Int @default(2)
  yearPlus    Int @default(2)
  peopleMinus Int @default(1)
  peoplePlus  Int @default(1)
  cabinsMinus Int @default(1)
  cabinsPlus  Int @default(1)
  headsMin    Int @default(0)

  locations Location[] @relation("FiltersLocations")

  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NEW: m2m –∫–∞–∫ —Å Locations
  categories YachtCategory[] @relation("FiltersCategories")
  builders   YachtBuilder[]  @relation("FiltersBuilders")
  models     YachtModel[]    @relation("FiltersModels")
  regions    Region[]        @relation("FiltersRegions")
  countries  Country[]       @relation("FiltersCountries")

  @@unique([orgId, scope, userId])
  @@index([scope])
  @@index([orgId])
  @@index([userId])
  @@map("competitor_filters")
}

// –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —è—Ö—Ç –∏–∑ NauSYS
model YachtCategory {
  id       Int     @id @default(autoincrement())
  nausysId Int     @unique
  names    Json
  nameEn   String? @map("name_en")
  nameDe   String? @map("name_de")
  nameRu   String? @map("name_ru")

  models YachtModel[] @relation("CategoryModels")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  competitorFilters CompetitorFilters[] @relation("FiltersCategories")

  yachts Yacht[]

  @@map("yacht_categories")
}

// –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π –∏–∑ NauSYS
model YachtBuilder {
  id       Int    @id @default(autoincrement())
  /// ID –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –≤ NauSYS (–ø–æ–ª–µ `builders[].id`), —É–Ω–∏–∫–∞–ª–µ–Ω
  nausysId Int    @unique
  /// –ò–º—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è (–ø–æ–ª–µ `builders[].name`)
  name     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // C–≤—è–∑—å –Ω–∞ –º–æ–¥–µ–ª–∏ —è—Ö—Ç
  models YachtModel[]

  competitorFilters CompetitorFilters[] @relation("FiltersBuilders")

  yachts Yacht[]

  @@index([name])
  @@map("yacht_builders")
}

// –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –º–æ–¥–µ–ª–µ–π —è—Ö—Ç –∏–∑ NauSYS
model YachtModel {
  id       Int    @id @default(autoincrement())
  nausysId Int    @unique
  name     String

  builderId Int?
  builder   YachtBuilder? @relation(fields: [builderId], references: [id])

  categoryId Int?
  category   YachtCategory? @relation("CategoryModels", fields: [categoryId], references: [id])

  loa           Decimal? @db.Decimal(6, 2)
  beam          Decimal? @db.Decimal(5, 2)
  draft         Decimal? @db.Decimal(4, 2)
  cabins        Int?
  wc            Int?
  waterTank     Int?
  fuelTank      Int?
  displacement  Int?
  virtualLength Int?

  competitorFilters CompetitorFilters[] @relation("FiltersModels")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([builderId])
  @@index([categoryId])
  @@map("yacht_models")
}

model CompetitorFilterPreset {
  id        String        @id @default(cuid())

  // --- —Å–≤—è–∑–∏ ---
  orgId     String
  userId    String?

  org       Organization  @relation("OrgPresets", fields: [orgId], references: [id])
  user      User?         @relation("UserPresets", fields: [userId], references: [id])

  // --- –æ–±—â–∏–µ –ø–æ–ª—è ---
  scope     FilterScope   // enum —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ —Å—Ö–µ–º–µ
  name      String

  // --- –ì–µ–æ—Ñ–∏–ª—å—Ç—Ä—ã ---
  countryIds   String[]   // UUID —Å—Ç—Ä–∞–Ω (countries.id)
  regionIds    Int[]      // PK —Ä–µ–≥–∏–æ–Ω–æ–≤ (regions.id)
  locationIds  String[]   // UUID –º–∞—Ä–∏–Ω (locations.id)

  // --- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ª–æ–¥–æ–∫ ---
  categoryIds  Int[]      // YachtCategory.id[]
  builderIds   Int[]      // YachtBuilder.id[]
  modelIds     Int[]      // YachtModel.id[]

  // --- –ß–∏—Å–ª–æ–≤—ã–µ –¥–æ–ø—É—Å–∫–∏ ---
  lenFtMinus   Int
  lenFtPlus    Int
  yearMinus    Int
  yearPlus     Int
  peopleMinus  Int
  peoplePlus   Int
  cabinsMinus  Int
  cabinsPlus   Int
  headsMin     Int

  // --- timestamps ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}