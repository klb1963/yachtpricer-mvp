generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique

  // –∫–æ–Ω—Ç–∞–∫—Ç—ã
  contactName  String?
  contactPhone String?
  contactEmail String?
  websiteUrl   String?

  yachts       Yacht[]
  subscription Subscription?

  users       User[]
  ownerYachts OwnerYacht[] @relation("OrgOwnerYachts")

  createdAt DateTime @default(now())
}

model Subscription {
  id    String       @id @default(cuid())
  orgId String       @unique
  org   Organization @relation(fields: [orgId], references: [id])

  plan             String    @default("PRO") // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ enum –ø–æ–∑–∂–µ
  status           String    @default("active")
  currentPeriodEnd DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Yacht {
  id       String  @id @default(uuid())
  nausysId String? @unique // üëà –≤–Ω–µ—à–Ω–∏–π ID NauSYS

  name                 String
  manufacturer         String
  model                String
  type                 YachtType @default(monohull)
  length               Float
  builtYear            Int
  cabins               Int
  heads                Int
  basePrice            Decimal   @db.Decimal(12, 2)
  location             String
  fleet                String
  charterCompany       String
  currentExtraServices Json

  imageUrl String?

  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  managerLinks ManagerYacht[]

  ownerLinks OwnerYacht[] @relation("OwnerYachtToYacht")

  ownerId   String?
  ownerName String?
  owner     Owner?  @relation(fields: [ownerId], references: [id])

  weekSlots           WeekSlot[]
  extraServiceHistory ExtraServiceHistory[]
  competitorPrices    CompetitorPrice[]
  competitorSnapshots CompetitorSnapshot[]
  pricingDecisions    PricingDecision[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([manufacturer, model])
  @@index([location])
  @@map("yachts")
}

model Owner {
  id     String  @id @default(uuid())
  name   String
  email  String  @unique
  phone  String?
  yachts Yacht[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("owners")
}

model WeekSlot {
  id      String @id @default(uuid())
  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  startDate       DateTime
  status          WeekSlotStatus
  currentPrice    Decimal        @db.Decimal(12, 2)
  currentDiscount Decimal        @db.Decimal(12, 2)

  priceHistory PriceHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([yachtId, startDate])
  @@index([yachtId, startDate])
  @@map("week_slots")
}

model PriceHistory {
  id         String   @id @default(uuid())
  weekSlot   WeekSlot @relation(fields: [weekSlotId], references: [id])
  weekSlotId String

  date     DateTime @default(now())
  price    Decimal  @db.Decimal(12, 2)
  discount Decimal  @db.Decimal(12, 2)
  authorId String?
  note     String?

  createdAt DateTime @default(now())

  @@map("price_history")
}

model ExtraServiceHistory {
  id      String @id @default(uuid())
  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  date        DateTime @default(now())
  serviceName String
  price       Decimal  @db.Decimal(12, 2)
  note        String?
  authorId    String?

  createdAt DateTime @default(now())

  @@map("extra_service_history")
}

enum WeekSlotStatus {
  BOOKED
  OPEN
  OPTION
}

enum YachtType {
  monohull
  catamaran
  trimaran
  compromis
}

enum ScrapeSource {
  BOATAROUND
  SEARADAR
}

enum JobStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

model CompetitorPrice {
  id      String  @id @default(uuid())
  yacht   Yacht?  @relation(fields: [yachtId], references: [id])
  yachtId String?

  // –Ω–µ–¥–µ–ª—è —á–∞—Ä—Ç–µ—Ä–Ω–∞—è (—Å—É–±–±–æ—Ç–∞)
  weekStart DateTime
  source    ScrapeSource

  // –∫—Ç–æ –∏ —á—Ç–æ: –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
  competitorYacht String
  price           Decimal  @db.Decimal(12, 2)
  currency        String
  link            String
  scrapedAt       DateTime @default(now())
  raw             Json?

  // üëá –Ω–æ–≤—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –ø–æ–ª—è –¥–ª—è Boataround
  scrapeJob   ScrapeJob? @relation(fields: [scrapeJobId], references: [id])
  scrapeJobId String?

  externalId  String? // ID –ª–æ–¥–∫–∏ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–µ—Å–ª–∏ —Å–º–æ–∂–µ–º –¥–æ—Å—Ç–∞—Ç—å)
  year        Int?
  cabins      Int?
  heads       Int?
  lengthFt    Float? // —É–¥–æ–±–Ω–µ–µ —Å—Ä–∞–∑—É —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ—É—Ç–∞—Ö
  marina      String?
  discountPct Decimal? @db.Decimal(12, 2) // —Ä–µ–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –Ω–∞ –∏—Ç–æ–≥ –ø—Ä–æ—Ç–∏–≤ ‚Äú–ø—Ä–∞–π—Å–∞‚Äù
  feesTotal   Decimal? @db.Decimal(12, 2) // –¥–æ–ø. —Å–±–æ—Ä—ã (—á–∏—Å—Ç–∫–∞/—Ç—É—Ä–∏—Å—Ç.–Ω–∞–ª–æ–≥ –∏ —Ç.–ø.), –µ—Å–ª–∏ —Å—á–∏—Ç–∞–µ–º

  // —á–∞—Å—Ç–æ —É–¥–æ–±–Ω–æ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ + –Ω–µ–¥–µ–ª—è + –∏—Å—Ç–æ—á–Ω–∏–∫:
  @@unique([source, link, weekStart])
  @@index([weekStart, source])
  @@index([yachtId, weekStart, source])
  @@map("competitor_prices")
}

model ScrapeJob {
  id         String       @id @default(uuid())
  source     ScrapeSource
  status     JobStatus
  params     Json
  createdAt  DateTime     @default(now())
  startedAt  DateTime?
  finishedAt DateTime?
  error      String?

  // üëá —Å–≤—è–∑—å –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
  results CompetitorPrice[]

  @@map("scrape_jobs")
}

enum DecisionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

model CompetitorSnapshot {
  id String @id @default(uuid())

  yacht   Yacht  @relation(fields: [yachtId], references: [id])
  yachtId String

  weekStart   DateTime
  source      ScrapeSource
  top1Price   Decimal      @db.Decimal(12, 2)
  top3Avg     Decimal      @db.Decimal(12, 2)
  currency    String
  sampleSize  Int
  rawStats    Json?
  collectedAt DateTime     @default(now())
  createdAt   DateTime     @default(now())

  @@unique([yachtId, weekStart, source])
  @@index([yachtId, weekStart])
  @@map("competitor_snapshots")
}

model PricingDecision {
  id          String         @id @default(uuid())
  yachtId     String
  yacht       Yacht?         @relation(fields: [yachtId], references: [id])
  weekStart   DateTime
  basePrice   Decimal        @db.Decimal(12, 2)
  top1        Decimal?       @db.Decimal(12, 2)
  top3        Decimal?       @db.Decimal(12, 2)
  mlReco      Decimal?       @db.Decimal(12, 2)
  discountPct Decimal?       @db.Decimal(12, 2)
  finalPrice  Decimal?       @db.Decimal(12, 2)
  status      DecisionStatus @default(DRAFT)
  approvedBy  String?
  approvedAt  DateTime?
  notes       String?
  auditJson   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs PriceAuditLog[] @relation("DecisionAuditLogs")

  @@unique([yachtId, weekStart])
  @@index([weekStart]) // üëà –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –ø–æ –Ω–µ–¥–µ–ª–µ
  @@index([status]) // üëà –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –ø–æ —Å—Ç–∞—Ç—É—Å—É
  @@map("pricing_decisions")
}

// --- RBAC: —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
enum Role {
  ADMIN
  FLEET_MANAGER
  MANAGER
  OWNER
}

// --- –†–µ–∂–∏–º—ã –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —è—Ö—Ç—ã ---
enum OwnerMode {
  ACTIVE
  VIEW_ONLY
  HIDDEN
}

// --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å clerkId/oidc sub) ---
model User {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?
  role  Role

  // –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å DEFAULT_ORG_SLUG=aquatoria)
  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  // —Å–≤—è–∑–∏
  managerLinks ManagerYacht[]
  ownerLinks   OwnerYacht[]
  auditLogs    PriceAuditLog[] @relation("AuditActor")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// --- –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫ —è—Ö—Ç–µ (–∫—Ç–æ ¬´–≤–µ–¥—ë—Ç¬ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —è—Ö—Ç—É) ---
model ManagerYacht {
  id        String @id @default(cuid())
  managerId String
  yachtId   String

  manager User  @relation(fields: [managerId], references: [id])
  yacht   Yacht @relation(fields: [yachtId], references: [id])

  @@unique([managerId, yachtId])
  @@index([yachtId])
  @@map("manager_yachts")
}

// --- –ü—Ä–∏–≤—è–∑–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (user —Å —Ä–æ–ª—å—é OWNER) –∫ —è—Ö—Ç–µ + —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞ ---
model OwnerYacht {
  id      String @id @default(cuid())
  ownerId String
  yachtId String

  // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å—Ç—Ä–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö org
  orgId String?
  // üëá –¥–∞—ë–º –∏–º—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É OwnerYacht ‚Üî Organization
  org   Organization? @relation("OrgOwnerYachts", fields: [orgId], references: [id])

  owner User @relation(fields: [ownerId], references: [id])

  // üëá –¥–∞—ë–º –∏–º—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É OwnerYacht ‚Üî Yacht
  yacht Yacht @relation("OwnerYachtToYacht", fields: [yachtId], references: [id])

  mode      OwnerMode @default(VIEW_ONLY)
  allowEdit Boolean   @default(false)

  @@unique([ownerId, yachtId])
  @@index([yachtId])
  @@map("owner_yachts")
}

// --- –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–æ workflow PricingDecision ---
enum AuditAction {
  SUBMIT
  APPROVE
  REJECT
}

model PriceAuditLog {
  id String @id @default(cuid())

  decisionId String

  decision PricingDecision @relation("DecisionAuditLogs", fields: [decisionId], references: [id])

  action     AuditAction
  fromStatus DecisionStatus?
  toStatus   DecisionStatus

  actorId String?
  actor   User?   @relation("AuditActor", fields: [actorId], references: [id])

  comment   String?
  createdAt DateTime @default(now())

  @@index([decisionId])
  @@index([actorId])
  @@map("price_audit_logs")
}
